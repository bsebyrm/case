name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  # ============================
  # 1) BUILD & PUSH IMAGES (GitHub Hosted)
  # ============================
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- Login to Huawei SWR ---
      - name: Login to SWR
        run: |
          echo "${{ secrets.SWR_PASSWORD }}" | docker login \
            -u "${{ secrets.SWR_USERNAME }}" \
            --password-stdin \
            swr.ap-southeast-3.myhuaweicloud.com

      # --- Build & Push Backend ---
      - name: Build & Push Backend
        run: |
          docker build -t backend:${{ github.sha }} ./mern-project/server
          docker tag backend:${{ github.sha }} ${{ secrets.SWR_REGISTRY }}/baykar-case/backend:${{ github.sha }}
          docker push ${{ secrets.SWR_REGISTRY }}/baykar-case/backend:${{ github.sha }}

      # --- Build & Push Frontend ---
      - name: Build & Push Frontend
        run: |
          docker build -t frontend:${{ github.sha }} ./mern-project/client
          docker tag frontend:${{ github.sha }} ${{ secrets.SWR_REGISTRY }}/baykar-case/frontend:${{ github.sha }}
          docker push ${{ secrets.SWR_REGISTRY }}/baykar-case/frontend:${{ github.sha }}

      # --- Build & Push ETL ---
      - name: Build & Push ETL
        run: |
          docker build -t etl:${{ github.sha }} ./python-project
          docker tag etl:${{ github.sha }} ${{ secrets.SWR_REGISTRY }}/baykar-case/etl:${{ github.sha }}
          docker push ${{ secrets.SWR_REGISTRY }}/baykar-case/etl:${{ github.sha }}

  # ============================
  # 2) DEPLOY TO CCE (Self-hosted Runner inside Huawei VPC)
  # ============================
  deploy-to-cce:
    needs: build-and-push
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- Setup kubeconfig on Runner VM ---
      - name: Setup kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG_DATA }}" | base64 -d > $HOME/.kube/config

      # --- Deploy Kubernetes manifests ---
      - name: Apply manifests
        run: |
          kubectl apply -f k8s/

      # --- Update images with new SHA tag ---
      - name: Rollout new images
        run: |
          kubectl set image deployment/backend backend=${{ secrets.SWR_REGISTRY }}/baykar-case/backend:${{ github.sha }} -n mern-app
          kubectl set image deployment/frontend frontend=${{ secrets.SWR_REGISTRY }}/baykar-case/frontend:${{ github.sha }} -n mern-app

          kubectl rollout status deployment/backend -n mern-app
          kubectl rollout status deployment/frontend -n mern-app

      # --- Restart ETL CronJob ---
      - name: Restart ETL CronJob
        run: |
          kubectl delete job --all -n mern-app || true
          kubectl rollout restart deployment/backend -n mern-app
