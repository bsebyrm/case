name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  # ============================
  # 1) BUILD & PUSH IMAGES
  # ============================
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- Login to Huawei SWR ---
      - name: Login to SWR
        run: |
          echo "${{ secrets.SWR_PASSWORD }}" | docker login ${{ secrets.SWR_REGISTRY }} \
            -u "${{ secrets.SWR_USERNAME }}" \
            --password-stdin

      # --- Build & Push Backend ---
      - name: Build & Push Backend
        run: |
          docker build -t backend:${{ github.sha }} ./mern-project/server
          docker tag backend:${{ github.sha }} ${{ secrets.SWR_REGISTRY }}/baykar-case/backend:${{ github.sha }}
          docker push ${{ secrets.SWR_REGISTRY }}/baykar-case/backend:${{ github.sha }}

      # --- Build & Push Frontend ---
      - name: Build & Push Frontend
        run: |
          docker build -t frontend:${{ github.sha }} ./mern-project/client
          docker tag frontend:${{ github.sha }} ${{ secrets.SWR_REGISTRY }}/baykar-case/frontend:${{ github.sha }}
          docker push ${{ secrets.SWR_REGISTRY }}/baykar-case/frontend:${{ github.sha }}

      # --- Build & Push ETL ---
      - name: Build & Push ETL
        run: |
          docker build -t etl:${{ github.sha }} ./python-project
          docker tag etl:${{ github.sha }} ${{ secrets.SWR_REGISTRY }}/baykar-case/etl:${{ github.sha }}
          docker push ${{ secrets.SWR_REGISTRY }}/baykar-case/etl:${{ github.sha }}

  # ============================
  # 2) DEPLOY TO CCE
  # ============================
  deploy-to-cce:
    needs: build-and-push
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- Setup kubeconfig on Runner VM ---
      - name: Setup kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG_DATA }}" | base64 -d > $HOME/.kube/config

      # ✅ Install Helm locally (No sudo required)
      - name: Install Helm (No sudo)
        run: |
          if ! command -v helm &> /dev/null
          then
            echo "Helm not found, installing locally..."

            HELM_VERSION="v3.20.0"

            curl -fsSL -o helm.tar.gz \
              https://get.helm.sh/helm-${HELM_VERSION}-linux-amd64.tar.gz

            tar -xzf helm.tar.gz

            mkdir -p $HOME/bin
            mv linux-amd64/helm $HOME/bin/helm

            echo "$HOME/bin" >> $GITHUB_PATH

            echo "Helm installed successfully!"
          else
            echo "Helm already installed"
          fi

      # ✅ Verify Helm installation
      - name: Check Helm Version
        run: helm version

      # --- Apply Kubernetes manifests (App Deploy) ---
      - name: Apply manifests (safe)
        run: |
          kubectl apply -f k8s/mongodb.yaml -n mern-app
          kubectl apply -f k8s/backend.yaml -n mern-app
          kubectl apply -f k8s/frontend.yaml -n mern-app
          kubectl apply -f k8s/ingress-frontend.yaml -n mern-app
          kubectl apply -f k8s/hpa-backend.yaml -n mern-app

      # ✅ Install Monitoring Stack (Prometheus + Grafana)
      - name: Install Monitoring Stack
        run: |
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo update

          kubectl create namespace monitoring || true

          helm upgrade --install kube-prometheus prometheus-community/kube-prometheus-stack \
            -n monitoring

      # ✅ Apply Alert Rules
      - name: Apply Alert Rules
        run: |
          kubectl apply -f k8s/monitoring/alert-rule.yaml

      # --- Update Backend & Frontend images ---
      - name: Update Backend & Frontend images
        run: |
          kubectl set image deployment/backend backend=${{ secrets.SWR_REGISTRY }}/baykar-case/backend:${{ github.sha }} -n mern-app
          kubectl set image deployment/frontend frontend=${{ secrets.SWR_REGISTRY }}/baykar-case/frontend:${{ github.sha }} -n mern-app

      # --- Update ETL CronJob image ---
      - name: Update ETL CronJob image
        run: |
          kubectl set image cronjob/etl-job etl=${{ secrets.SWR_REGISTRY }}/baykar-case/etl:${{ github.sha }} -n mern-app

      # --- Wait for rollouts ---
      - name: Wait for deployments
        run: |
          kubectl rollout status deployment/backend -n mern-app
          kubectl rollout status deployment/frontend -n mern-app

      # --- Show final pod status ---
      - name: Check Pods
        run: |
          kubectl get pods -n mern-app
          kubectl get ingress -n mern-app
          kubectl get hpa -n mern-app
          kubectl get pods -n monitoring
